# 未登录访客模式与前端日志优化实施方案（实施前最终版）

本文档聚合了当前日志问题与“未登录仅开放基础能力”的新需求，给出一致的产品策略、实现思路、组件级修改点与验收标准，便于评审后一次性落地实施。

---

执行摘要（TL;DR）
- 访客（未登录）：仅允许基础 SSH 连接 + 延迟显示；工具栏禁用、左侧监控面板和 AI 输入栏均不显示；入口按钮提示“登录后可使用”。
- 已登录：功能完整；工具栏新增 AI 图标，点击在终端底部滑入/滑出 AI 输入栏；左侧监控面板默认显示。
- 设置策略：仅 UI 主题始终本地；其余设置（terminal/connection/editor/advanced）遵循“未登录用本地、登录用服务器”。默认主题为 dark。
- 日志优化：去闭环/降频/汇总，保留关键排障价值，不修改 log.js 与日志级别。

## 1. 背景与目标
- 背景：目前前端日志存在重复与噪音，且未登录（guest）与已登录（user）之间的数据源/能力边界不够清晰，易造成误解和多余请求/日志。
- 目标：
  - 明确“未登录仅开放基础 SSH 连接与延迟显示”，其余功能需登录后使用。
  - 在设置界面增加“是否允许未登录使用基础功能”的开关，系统可一键关闭/开启访客模式。
  - 优化日志输出，降低重复与高频打印，保留关键排障价值。

## 2. 需求摘要（含主题与设置策略）
- 访客可用范围：
  - 允许：基础 SSH 连接、终端打开、网络延迟显示（ping/latency）。
  - 禁止（需登录）：SFTP 文件管理、脚本库、AI 面板/AI 请求、终端智能补全、历史/收藏/置顶管理、监控（CPU/内存/网络等面板）。
- 新增系统级开关（设置界面）：
  - 文案：允许未登录用户使用基础功能（访客模式）
  - 说明：仅开放基础 SSH 连接与延迟显示，其他功能需登录。
  - 样式：参考现有启用禁用按钮。
  - 行为：关闭后，未登录用户无法使用任何终端连接能力（直接引导登录）。
- 设置加载/保存策略：
  - 主题（UI 主题）设置：始终使用本地存储（local），不从服务器读取/写回；适用于未登录和已登录两种状态。
  - 其他所有设置（terminal/connection/editor/advanced 等）：未登录使用本地存储；已登录使用服务器端设置（读取与写回）。
- 默认主题：将系统默认 UI 主题设为暗色（dark）。
- 日志优化：在不修改 log.js 与日志级别的前提下，通过调用点控频、等值判断与汇总输出，解决重复、冗余与高频问题。

决策记录（Key Decisions）
- ESC 关闭 AI 输入栏：不支持（通过再次点击 AI 图标关闭）。
- 访客模式默认值：关闭（false），生产安全默认最小权限；开发环境可通过 .env 决定是否默认开启（可选）。
- 工具栏在访客模式：默认整条禁用，提供统一 Tooltip（可选保留基础操作的变体延后评审）。

## 3. 行为矩阵
- 访客模式开（allowGuestBasicFeatures = true）：
  - 未登录（guest）：仅基础 SSH + 延迟；其它功能显示登录引导。
  - 已登录（user）：全部功能可用。
- 访客模式关（allowGuestBasicFeatures = false）：
  - 未登录：所有功能不可用，进入连接/终端等路径直接跳转登录或弹出登录引导。
  - 已登录：全部功能可用。

## 4. 交互与 UI
- 位置：设置 > 高级（Advanced）
- 开关：
  - 键名（建议）：advanced.allowGuestBasicFeatures（默认 false，生产环境更符合安全预期）
  - 仅管理员可修改（建议）：如当前系统未区分角色，也可先全部用户可见；后续再加“仅 admin 可编辑”。
- 引导与提示：
  - 访客尝试进入受限功能（SFTP/AI/监控/脚本库等）时，弹出登录提示（保留最少一次日志）。

## 5. 配置与数据流
- 设置存储：沿用现有 SettingsService/StorageAdapter 机制，advanced 类别会保存到服务器；未登录下仅本地存储。
- 默认值：`userSettingsDefaults.advanced.allowGuestBasicFeatures = false`
- 读取顺序：登录时优先服务器设置；未登录读取本地（与现有策略一致）。
- 主题默认与防闪烁：
  - UI 默认主题设为 `dark`（开发与生产保持一致）。
  - 防闪烁脚本/初始化逻辑（若存在）优先读取本地主题；若无记录，则使用 `dark`；避免初屏亮暗闪烁。

配置键与来源
- 主题（仅本地）：`easyssh:user_settings.ui.*`
- 其它设置：
  - 本地：`easyssh:user_settings.<category>`（备份/离线）
  - 服务器：`/users/settings?category=<category>`（terminal/connection/editor/advanced）
- 访客模式开关：`advanced.allowGuestBasicFeatures`（服务器/本地遵循登录策略）

## 6. 功能门控点（需修改/新增的判断）
1) 终端与 SSH：
   - 创建终端/发起连接前：
     - if 未登录 且 allowGuestBasicFeatures=false → 阻止并提示登录。
     - if 未登录 且 allowGuestBasicFeatures=true → 允许仅基础 SSH 连接。
   - Monitoring：未登录仅启用“延迟测量”（latency/ping），不启动 CPU/内存/网络采集或仪表面板。

2) 终端智能补全（terminal-autocomplete）：
   - 仅在“已登录 && allowGuestBasicFeatures==任意”时 enable()，未登录禁用并隐藏所有 UI。
   - 日志：未登录不打印“已启用”，改为一次性“补全未启用（guest）”。（标注：调低频率/简化内容）

3) AI 面板与 AI 服务：
   - 未登录不加载/不启用 AI 配置，不显示 AI 面板交互入口；点击时弹登录提示。
   - 登录后再按当前配置决定是否自动启用。

4) SFTP 文件管理：
   - 未登录禁止打开 SFTP 面板；若页面已有入口，点击时弹登录提示。

5) 脚本库/历史/收藏/置顶：
   - 未登录禁止调用相关 API 与交互；保持本地只读或完全隐藏入口。

6) 路由层守卫（可选增强）：
   - 对 /sftp、/monitoring（高级）、/ai 等受限路由进行守卫：未登录则重定向至登录页并携带 returnTo。

## 6.1 终端工具栏与 AI 输入栏/监控面板（新增 UI 与访客交互）

- 工具栏新增 AI 图标：
  - 位置：终端工具栏右侧功能区，图标命名 `icon-ai`（保持与现有风格一致）。
  - 行为（已登录）：点击后“AI 输入栏”自底部向上滑入至当前位置（现有布局位置），再次点击/关闭时向下滑出。
  - 行为（未登录）：图标显示为禁用态（opacity 降低、cursor: not-allowed），悬浮显示 Tooltip：“登录后可使用”。点击无效（不触发事件）。

- AI 输入栏动画规范：
  - 初始状态：`transform: translateY(100%); opacity: 0; visibility: hidden;`
  - 进入：添加类 `.ai-input--enter` 触发 `transform: translateY(0); opacity: 1; visibility: visible;`，过渡 200–300ms（与全局动画时长一致）。
  - 离开：反向动画至初始状态；动画结束后从 DOM 中卸载以减少开销。
  - 可访问性：进入后聚焦到输入框；aria-live=polite 用于结果提示区域（不再使用 ESC 关闭）。

- 左侧监控面板（默认显示）策略：
  - 已登录：遵循“默认显示”规则，用户可手动隐藏/显示；记忆用户选择。
  - 未登录（访客）：不显示（强制隐藏），入口按钮禁用并提示“登录后可使用”。不初始化监控数据流，仅保留延迟显示在工具栏。

- 访客模式下工具栏交互：
  - 默认行为：整条工具栏进入“受限模式”，所有功能按钮不可点击，统一 Tooltip：“登录后可使用”。
  - 备选（可选项，评审决定）：保留基础终端操作（如清屏、复制/粘贴、查找）可用，其余禁用；本方案默认采取“全部禁用”以避免歧义。
  - 技术要点：使用 `disabled` 与 `aria-disabled` 同步禁用；同时允许 Tooltip 触发（避免 `pointer-events: none` 影响悬浮），可在按钮容器上处理 tooltip 与阻止点击。

- 状态判定：
  - `isGuest = !userStore.isLoggedIn`。
  - 监控与 AI 输入栏显示条件：`!isGuest`。
  - 工具栏可点击条件：`!isGuest`（若采用“部分保留”则细分白名单）。
  - SSH 延迟显示：`true`（已登录/未登录均显示）。

- 事件流与通信：
  - 工具栏 AI 图标点击 → 触发 `ai:toggle-input` 事件（或直接调用终端视图方法），带上 `terminalId`；
  - 终端视图响应：根据状态添加/移除 `.ai-input--enter` 类；
  - 关闭场景：再次点击图标（或切换标签/终端）触发关闭（不提供 ESC 关闭）。

- 日志建议：
  - 已登录：首次展开/收起各记录一次 debug；
  - 未登录：悬浮提示不记录；点击被阻止时最多记录一次 debug：“访客模式下工具栏已禁用”。

UI 组件与样式约定（便于快速实现）
- 组件：
  - `ToolbarAIButton`（或在 TerminalToolbar.vue 内实现）：新增 AI 图标按钮，props：`disabled: boolean`；发射 `ai:toggle-input`。
  - `AIInputBar`（新组件，或在 Terminal.vue 内部实现 DOM 块）：
    - props：`visible: boolean`, `terminalId: string`
    - 进入类名：`.ai-input--enter`；隐藏：移除该类或添加 `.ai-input--leave`
    - 过渡：`transition: transform .25s ease, opacity .25s ease`
  - 监控面板（现有左侧）：访客隐藏，已登录默认显示。
- 样式类：
  - 按钮禁用（访客）：`.is-guest-disabled`（光标与不透明度由该类控制，保留 hover 以展示 Tooltip）。
  - AI 输入栏容器：`.ai-input`，进入：`.ai-input--enter`（translateY(0) + opacity:1），初始：translateY(100%) + opacity:0。


## 7. 日志优化（不改 log.js 与级别，仅在调用点执行）
- 设置保存回写闭环：
  - settings.set(path,value) 增加等值判断（值相同不写、不打日志）。
  - saveSettings() 增加“合并期间暂停 watch”的批处理窗口；结束后仅在有差异时保存与打印一次汇总。
  - storage-adapter.set() 增加 options.origin/silent，来源为 settings 保存时跳过反向 settingsService.set()，避免循环。
- 功能状态带上下文：在关键日志入参对象中附带 `mode: 'guest'|'user'` 与 `source: 'local'|'server'`，便于筛选分析。
- 终端尺寸：仅保留最终“调整完成(cols×rows)”；提高防抖至 150–200ms；“变化/已调整”作为内部 trace 或加阈值（尺寸变化极小不打印）。
- SFTP 二进制：对 SUCCESS/数据帧按 operationId 做采样/聚合，只打印首帧+尾帧或输出一条“目录加载完成（entries/bytes/耗时）”。
- AI 面板：initializeTerminal 仅首次打印；连续高度变更合并为一次（已有阈值>10px，保持或再合并 200ms 窗口）。
- 渲染器：仅打印一条“渲染器: 请求=<配置>, 实际=Canvas（WebGL禁用）”，去掉重复表述。

埋点/观测（若采纳建议字段）
- 在关键日志对象中增加：`mode`, `source`, `feature`, `sessionId|terminalId|operationId`。
- 指标：AI 输入栏展开率、访客点击被阻止次数、SFTP 列表操作平均日志数、终端 resize 日志数。（用于后评估降噪成效）
- Token/敏感信息：生产环境不再打印 token 预览片段。

## 8. 代码改动点清单（不含实现细节）
- 配置与设置
  - src/config/app-config.js：
    - `advanced.allowGuestBasicFeatures` 默认 false。
    - UI 默认主题 `ui.defaultTheme`/`userSettingsDefaults.ui.theme` 统一改为 `dark`。
  - src/services/settings.js：
    - set() 等值判断；批处理暂停 watch；getTerminalOptions() 等日志仅首次/有变更打印。
    - 明确：主题（UI 主题）读取/保存仅本地；其余设置登录用服务器、未登录用本地（现有逻辑已基本符合，补充注释与边界处理）。
  - src/services/storage-adapter.js：set() 支持 options.origin/silent，避免回写闭环；仅在检测到差异时“同步更新设置服务”。

- 功能门控
  - src/services/ssh/terminal-manager.js：根据登录态与 allowGuestBasicFeatures 决定是否 enable 补全、是否启动非延迟监控；在 guest 模式下只保留延迟测量。
  - src/services/terminal-autocomplete.js：未登录 disable() 且仅一次性打印“未启用（guest）”。
  - src/services/ai/ai-service.js：未登录不 load/enable；登录后去重加载（2–3 秒窗口或状态标志）。
  - src/layouts/AppLayout.vue：SFTP 面板入口在未登录下弹登录提示；closeSftpPanel() 合并为一次汇总日志并加幂等保护。
  - src/router/index.js（可选）：受限路由守卫。

- 日志优化
  - src/services/ssh/sftp-service.js：非进度帧采样/聚合；进度保持节流。
  - src/store/terminal.js 与 src/services/ssh/terminal-manager.js：合并尺寸日志、提升防抖。
  - src/services/terminal.js：渲染器日志统一为一条。

— 组件级改动（新增/修改点一览）
- 终端工具栏（src/components/terminal/TerminalToolbar.vue）：
  - 新增 AI 图标按钮；根据 `isGuest` 设置禁用+Tooltip；点击发射 `ai:toggle-input`（携带 active terminalId）。
  - 访客模式下：全部按钮 `disabled` 或应用 `.is-guest-disabled`。
- 终端视图（src/views/terminal/Terminal.vue）：
  - 监听 `ai:toggle-input` → 切换 AI 输入栏显隐；实现底部滑入/滑出过渡；进入后自动聚焦输入框。
  - 切换标签/终端时关闭 AI 输入栏。
- 左侧监控面板（src/components/monitoring/* 或 Terminal 视图内）：
  - 访客隐藏；已登录默认显示（保持当前默认）。
- SFTP 入口（src/layouts/AppLayout.vue 或相关入口）：
  - 访客点击提示登录，不打开面板；登录时正常逻辑。

## 13. 补充建议与优化点
- 主题迁移策略：
  - 新用户：默认 `dark`；
  - 老用户：若已在本地有主题记录（light/system/dark），尊重其选择，不强制覆盖；仅在无本地记录时采用 `dark`。
- 设置界面说明文案：
  - 在“访客模式开关”旁增加说明：未登录仅开放基础 SSH 与延迟显示，其余功能需登录；管理员可一键关闭访客模式。
  - 在主题设置模块增加“此设置仅在本机生效”的提示（主题仅本地）。
- 登录态切换时的设置合并：
  - 从 guest → user：
    - 非主题设置：优先读取服务器；如本地存在未上传变更，可提供一次“合并/覆盖”选项（未来增强）。
    - 主题：继续使用本地值，不做上传与覆盖。
  - 从 user → guest（登出）：保持本地主题不变，其他设置回退为本地快照（若存在），否则回默认。
- 路由与入口提示：
  - 受限功能入口（SFTP/AI/监控/脚本库）在未登录时展示统一的“登录以使用”提示（一次性日志 + 统一组件）。
- 可观测性：
  - 在关键日志对象中补充 `mode: 'guest'|'user'` 与 `source: 'local'|'server'` 字段，便于问题定位与过滤分析。
- 安全与隐私：
  - 移除 token 预览/长度等非必要输出（生产）；
  - 访客模式默认关闭，遵循“默认最小权限”。


## 9. 兼容性与迁移
- 迁移默认：若服务器端未存储 `advanced.allowGuestBasicFeatures`，生产环境默认 false，开发环境可由 .env 覆盖（可选）。
- 现有访客行为：与当前“未登录可打开终端”等行为相比，将被严格限制；需在变更日志与发布说明中说明。

## 10. 验收与测试用例（示例）
1) 访客模式开/关覆盖：
   - 关：未登录尝试打开终端/连接 → 引导登录；登录后可用。
   - 开：未登录可打开终端并显示延迟；SFTP/AI/监控高级功能均提示登录。
2) 登录切换：
   - 登录前建立的终端在登录后不被销毁；新开终端具备完整能力（补全/AI 可用）。
3) 日志：
   - 设置保存不再出现成对重复；终端尺寸一次调整只出现最终一条；SFTP 目录操作输出 1–2 条汇总；渲染器仅 1 条。
4) UI：
   - 设置 > 高级出现访客模式开关（样式与其他开关一致）；切换后行为符合预期（可即时或下次生效，根据实现）。
5) 工具栏与 AI 输入栏：
   - 工具栏新增 AI 图标，登录时可点击，未登录禁用+Tooltip；
   - 登录点击 AI 图标时，AI 输入栏从底部滑入至现有位置；再次点击关闭时滑出（不支持 ESC 关闭）；
   - 未登录时 AI 输入栏不显示；
   - 未登录时左侧监控面板不显示；
   - SSH 延迟显示在两种状态下均正常。

交付标准（Done Criteria）
- 所有门控与 UI 交互符合上文“行为矩阵”“6.1”与“验收用例”。
- 日志在相同行为路径不出现重复（设置保存闭环移除、SFTP 列表 1–2 条汇总、渲染器仅 1 条）。
- 主题 dark 默认正确应用；无亮/暗闪烁；老用户历史主题选择保留。
- 受限入口均给出一致的 Tooltip/引导提示；不会意外打开受限功能。

## 11. 风险与回退
- 风险：功能门控误判导致能力被禁/放开；日志过度收敛影响排障。
- 回退：保留开关与环境变量，必要时在生产临时放开访客模式或恢复原日志策略。

## 12. 实施阶段与工期（粗估）
- 阶段 A（门控与 UI 开关）：1–1.5 天
- 阶段 B（日志优化）：1 天
- 阶段 C（测试与修正）：0.5–1 天

—— 以上为实施草案，待评审通过后可分支实现并按阶段合并。

## 13. 策略细化：设置读写边界与冲突解决
- 主题仅本地：
  - 本地键：`easyssh:user_settings.ui.*`（或等价前缀），不上传服务器；登录/登出均不影响主题本地值。
- 其它设置（terminal/connection/editor/advanced）：
  - 未登录：读/写本地；
  - 已登录：读/写服务器；本地作为缓存/备份，网络异常时回退读取。
- 登录切换冲突（guest→user）：
  - 读取服务器为主；如本地存在最近变更（可对比时间戳），提供“合并/覆盖”提示（后续增强）。
  - 主题：继续沿用本地值（不上传）。
- 登出（user→guest）：
  - 主题保留；其它设置回退到本地快照或默认值。

## 14. 日志标签与可观测性（建议）
- 为关键日志的结构化对象增加：
  - `mode`: `guest | user`
  - `source`: `local | server`
  - `feature`: `sftp | ai | autocomplete | monitoring | terminal | settings`
- 采样与节流：
  - 帧级/高频（SFTP/resize）按 operationId 或事件窗口节流；
  - 阶段性动作（初始化/清理）仅打印一次汇总。
- 相关 ID 关联：将 `sessionId | terminalId | operationId` 带入同一条汇总日志，减少逐帧打印。

## 15. 受限入口与路由守卫（建议）
- 入口组件：
  - 未登录点击 SFTP/AI/监控/脚本库时，弹出统一登录引导（一次性日志）。
- 路由守卫：
  - 对受限路由添加 beforeEach 守卫，未登录时重定向到登录页，并带 `returnTo`。

## 16. 默认主题 dark 的迁移方案
- 新用户：无本地记录 → 采用 `dark`。
- 老用户：若已有本地主题记录（`light/system/dark`），尊重其当前选择，不覆盖；
- 防闪烁：初始化早期读取本地主题（无则 `dark`），再初始化应用以避免亮/暗抖动。

## 17. 开放问题与决策点
- 高优先级：
  - 访客模式默认值是否允许在开发环境下通过 .env 强制开启？（便于联调）
  - 连接数据的“合并/覆盖”是否在首个版本中上线，或延后？
- 中优先级：
  - 受限入口的 UI 呈现：隐藏 vs 灰化 + 提示？
  - 角色权限（仅管理员可改访客开关）是否在本期引入？
- 低优先级：
  - 是否需要在设置页标注“主题仅本地生效”的二级提示？

## 18. QA 测试清单与成功标准
- 访客模式覆盖：开/关两种状态 + 未登录/已登录切换；
- 能力门控：SFTP/AI/监控/脚本库/补全在 guest 下全部受限；
- 设置策略：主题仅本地；其它设置按登录状态正确读写；
- 日志：
  - 设置保存不再双次；
  - SFTP 目录操作 1–2 条汇总，resize 仅最终一次；
  - 核心日志包含 mode/source 便于过滤（若采纳）。

实施检查清单（开发勾选）
- [ ] 配置键与默认值落地（advanced.allowGuestBasicFeatures, 默认主题 dark）。
- [ ] 工具栏 AI 图标与禁用态 + Tooltip。
- [ ] AI 输入栏滑入/滑出动画、焦点与状态保持。
- [ ] 访客隐藏左侧监控面板；登录默认显示。
- [ ] 受限入口（SFTP/AI/监控/脚本库）提示登录；不触发原逻辑。
- [ ] 日志优化三项：设置闭环、SFTP 帧节流、渲染器统一。
- [ ] 单元/集成测试与手动验收通过。
