# âœ… æœ€ç»ˆä¿®å¤æ–¹æ¡ˆ

## ğŸ”§ æ ¸å¿ƒé—®é¢˜è§£å†³

### 1. **libcå…¼å®¹æ€§é—®é¢˜**
- **é—®é¢˜**: Alpine (musl libc) ç¼–è¯‘ â†’ Debian (glibc) è¿è¡Œ
- **è§£å†³**: ç»Ÿä¸€ä½¿ç”¨Debianç³»ç»Ÿ
  - æ„å»ºé˜¶æ®µ: `node:20-bullseye` (å®Œæ•´ç¯å¢ƒï¼Œé€‚åˆç¼–è¯‘)
  - è¿è¡Œé˜¶æ®µ: `node:20-slim` (ç²¾ç®€ç¯å¢ƒï¼Œç›¸åŒlibc)

### 2. **nginxæƒé™é—®é¢˜**
- **é—®é¢˜**: érootç”¨æˆ·æ— æ³•åˆ›å»ºnginxä¸´æ—¶ç›®å½•
- **è§£å†³**: é¢„åˆ›å»ºæ‰€éœ€ç›®å½•å¹¶è®¾ç½®æƒé™
  ```dockerfile
  mkdir -p /var/log/nginx /var/cache/nginx /var/lib/nginx /run/nginx
  chown -R appuser:appuser /var/log/nginx /var/cache/nginx /var/lib/nginx /run/nginx
  ```

### 3. **nginxé…ç½®ä¼˜åŒ–**
- **ä¿®æ”¹**: PIDæ–‡ä»¶è·¯å¾„ `/var/run/nginx.pid` â†’ `/run/nginx/nginx.pid`
- **ä¿®æ”¹**: é™æ€æ–‡ä»¶è·¯å¾„ `/usr/share/nginx/html` â†’ `/app/public`

## ğŸ—ï¸ ä¼˜åŒ–çš„æ„å»ºç­–ç•¥

```dockerfile
# æ„å»ºé˜¶æ®µ - ä½¿ç”¨å®Œæ•´ç¯å¢ƒ
FROM node:20-bullseye AS frontend-builder
FROM node:20-bullseye AS backend-builder

# è¿è¡Œé˜¶æ®µ - ä½¿ç”¨ç²¾ç®€ç¯å¢ƒ
FROM node:20-slim AS runtime
```

### ä¼˜åŠ¿:
- âœ… è§£å†³libcå…¼å®¹æ€§é—®é¢˜
- âœ… better-sqlite3æ­£ç¡®ç¼–è¯‘å’Œè¿è¡Œ
- âœ… ä¿æŒé•œåƒç²¾ç®€ (~300MB)
- âœ… æ„å»ºæ—¶é—´ä¼˜åŒ– (~17åˆ†é’Ÿ)

## ğŸ“Š é¢„æœŸæ•ˆæœ

| æŒ‡æ ‡ | ä¿®å¤å‰ | ä¿®å¤å | çŠ¶æ€ |
|------|--------|--------|------|
| **ä¾èµ–å†²çª** | âŒ piniaç‰ˆæœ¬å†²çª | âœ… å·²è§£å†³ | ä¿®å¤ |
| **libcå…¼å®¹æ€§** | âŒ muslâ†’glibcä¸å…¼å®¹ | âœ… ç»Ÿä¸€glibc | ä¿®å¤ |
| **nginxæƒé™** | âŒ æƒé™æ‹’ç» | âœ… æ­£ç¡®æƒé™ | ä¿®å¤ |
| **é•œåƒå¤§å°** | 800MB | ~300MB | ä¼˜åŒ– |
| **æ„å»ºæ—¶é—´** | 30åˆ†é’Ÿ | ~17åˆ†é’Ÿ | ä¼˜åŒ– |

## ğŸš€ ç°åœ¨å¯ä»¥æ„å»ºäº†ï¼

```bash
git add .
git commit -m "fix: è§£å†³libcå…¼å®¹æ€§å’Œnginxæƒé™é—®é¢˜"
git push origin main
```

## ğŸ” ä¿®æ”¹æ–‡ä»¶æ€»ç»“

### æ ¸å¿ƒä¿®æ”¹:
1. **Dockerfile**: 
   - æ„å»ºé˜¶æ®µä½¿ç”¨ `node:20-bullseye`
   - è¿è¡Œé˜¶æ®µä½¿ç”¨ `node:20-slim`
   - ä¿®å¤nginxæƒé™è®¾ç½®

2. **nginx.conf**:
   - PIDæ–‡ä»¶è·¯å¾„ä¿®æ­£
   - é™æ€æ–‡ä»¶è·¯å¾„ä¿®æ­£

3. **start.sh**:
   - ç¡®ä¿nginxç›®å½•å­˜åœ¨

### ä¾èµ–ä¿®å¤:
4. **package.json**:
   - `pinia-plugin-persistedstate`: `^4.2.0` â†’ `^3.2.1`

## ğŸ¯ æ„å»ºéªŒè¯ç‚¹

æ¨é€ååœ¨GitHub Actionsä¸­éªŒè¯:
1. âœ… å‰ç«¯æ„å»ºæˆåŠŸ (bullseyeç¯å¢ƒ)
2. âœ… åç«¯ç¼–è¯‘æˆåŠŸ (better-sqlite3æ­£ç¡®ç¼–è¯‘)
3. âœ… å®¹å™¨å¯åŠ¨æˆåŠŸ (slimç¯å¢ƒè¿è¡Œ)
4. âœ… nginxæ­£å¸¸è¿è¡Œ (æƒé™æ­£ç¡®)
5. âœ… å¥åº·æ£€æŸ¥é€šè¿‡ (æœåŠ¡å¯è®¿é—®)

## ğŸ› ï¸ å¦‚æœä»æœ‰é—®é¢˜

### å¤‡ç”¨æ–¹æ¡ˆ1: å…¨éƒ¨ä½¿ç”¨bullseye
```dockerfile
# å¦‚æœslimä»æœ‰é—®é¢˜ï¼Œå¯ä»¥å…¨éƒ¨ä½¿ç”¨bullseye
FROM node:20-bullseye AS runtime
```

### å¤‡ç”¨æ–¹æ¡ˆ2: ä½¿ç”¨ç¨³å®šç‰ˆ
```bash
# ä½¿ç”¨é¢„å¤‡çš„ç¨³å®šç‰ˆé…ç½®
cp Dockerfile.stable Dockerfile
```

---

**ğŸ‰ è¿™æ¬¡åº”è¯¥èƒ½æˆåŠŸæ„å»ºäº†ï¼bullseyeâ†’slimçš„ç»„åˆæ˜¯æœ€ä½³å®è·µã€‚**
